<!DOCTYPE html>
	<head>
	     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
   			integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   			crossorigin=""/>
	     <link rel = "stylesheet" href="css/style.css">
	     <title> Air Quality </title> 
		
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	</head>

	<body>
	    <div id="navigation">
	         <ul id = pages>
  	              <li><a class="active" href= "index.html">Home</a></li>
                      <li><a href="about.html">About</a></li>
		 </ul>
	    </div>
	    <div id="map"></div>
	    <div id="map2"></div>
	 
	     <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
   	          integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
   	          crossorigin=""></script>
	     <script src="js/script.js"></script>
		
	
		 <div id="map"></div>
  
  
		<div id="app">
			<input v-model="lat" placeholder="Enter Latitude" id="lat"/><br>
			<input v-model="lon" placeholder="Enter Longitude" id="lon"/><br>
			<input v-model="loc" placeholder="Enter Location" id="loc"/><br>
			<button type="button" onclick="callFunc()"> Update </button><br>
			
			
			<!-- NEW -->
			<input v-model="lat2" placeholder="Enter Latitude" id="lat2"/><br>
			<input v-model="lon2" placeholder="Enter Longitude" id="lon2"/><br>
			<input v-model="loc2" placeholder="Enter Location" id="loc2"/><br>
			<button type="button" onclick="callFunc2()"> Update </button><br>
			
			
			
		</div>
		
		
		<div id="data">
			<table id="table">
				<tr id="row">
					<td id="column"></td>
				</tr>
			</table>
		</div>
	</body>






<script type="text/javascript"> 
	//NEW
		var vm = new Vue({ 
			el: '#app',
				data: {   
					lat: map.getCenter().lat,  
					lon: map.getCenter().lng,
					lat2: map2.getCenter().lat,
					lon2: map2.getCenter().lng,
					loc: 'a',
					loc2: 'b',
					radius: '356177.86',
					radius2: '356177.86'
				}
		});
   
		
		
	//NEW
		map.on('drag', function(){
			vm.lat = map.getCenter().lat;
			vm.lon = map.getCenter().lng;
			getRadius();
			var url = "https://api.openaq.org/v1/measurements?coordinates=" + vm.lat + "," + vm.lon + "&radius=" + vm.radius;
			var p = GetJSON(url);
		});
		map2.on('drag', function(){
			vm.lat2 = map2.getCenter().lat;
			vm.lon2 = map2.getCenter().lng;
			getRadius2();
			var url = "https://api.openaq.org/v1/measurements?coordinates=" + vm.lat2 + "," + vm.lon2 + "&radius=" + vm.radius2;	
			var p = GetJSON(url);
			
		});
   
   
	//	var marker = L.marker([55, 5]).addTo(map);
	//	marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
   
	//NEW
		var callFunc2 = function(){
	
			map2.panTo([vm.lat2, vm.lon2], 13);
			getRadius2();
			
			var url = "https://api.openaq.org/v1/measurements?coordinates=" + vm.lat2 + "," + vm.lon2 + "&radius=" + vm.radius2;
		
			var p = GetJSON(url);
		}
				
				
		var callFunc = function(){
			
		//NEW
			map.panTo([vm.lat, vm.lon], 13);
			getRadius();
			console.log(vm.radius);
			var url = "https://api.openaq.org/v1/measurements?coordinates=" + vm.lat + "," + vm.lon + "&radius=" + vm.radius;
		
			var p = GetJSON(url);
			p.then(results => {
				console.log(results);

						for(i=0; i<results.results.length; i++){
						
							var newRow = document.createElement("TR");
							var text = document.createTextNode(results.results[i].location);

							
						
							var newColumn = document.createElement("TH");
							
								var text1 = document.createTextNode(results.results[i].city + "   ");
								var text2 = document.createTextNode(results.results[i].coordinates.latitude + "   ");
								var text9 = document.createTextNode(results.results[i].coordinates.longitude + "   ");
								var text3 = document.createTextNode(results.results[i].country + "   ");
								var text4 = document.createTextNode(results.results[i].date.utc + "   ");
								var text5 = document.createTextNode(results.results[i].location + "   ");
								var text6 = document.createTextNode(results.results[i].parameter + "   ");
								var text7 = document.createTextNode(results.results[i].unit + "   ");
								var text8 = document.createTextNode(results.results[i].value + "   ");
								newRow.appendChild(text1);
								newRow.appendChild(text2);
								newRow.appendChild(text9);
								newRow.appendChild(text3);
								newRow.appendChild(text4);
								newRow.appendChild(text5);
								newRow.appendChild(text6);
								newRow.appendChild(text7);
								newRow.appendChild(text8);
							
							document.getElementById("row").appendChild(newRow);
							
							
							
						//	var text2 = document.createTextNode(results.results[i].country);
						//	newColumn.appendChild(text2);
						//	document.getElementById("column").appendChild(newColumn);
						
						
				}
			});
			}
			
			function getRadius(){
				var northEastLat = map.getBounds()._northEast.lat;
				var northEastLon = map.getBounds()._northEast.lng;
				var southWestLat = map.getBounds()._southWest.lat;
				var southWestLon = map.getBounds()._southWest.lng;
						
				var lat1 = northEastLat*Math.PI/180;
				var lon1 = northEastLon*Math.PI/180;
				var lat2 = southWestLat*Math.PI/180;
				var lon2 = southWestLon*Math.PI/180;
			
				var dLat = southWestLat-northEastLat;
				var dLon = southWestLon-northEastLon;
	
				var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2)
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				var distance = 3958.8 * c;
				var radius = distance/2;
				var radiusMeters = radius * 1609.34;
				vm.radius = radiusMeters;
			}
			
			function getRadius2(){
				var northEastLat = map2.getBounds()._northEast.lat;
				var northEastLon = map2.getBounds()._northEast.lng;
				var southWestLat = map2.getBounds()._southWest.lat;
				var southWestLon = map2.getBounds()._southWest.lng;
						
				var lat1 = northEastLat*Math.PI/180;
				var lon1 = northEastLon*Math.PI/180;
				var lat2 = southWestLat*Math.PI/180;
				var lon2 = southWestLon*Math.PI/180;
			
				var dLat = southWestLat-northEastLat;
				var dLon = southWestLon-northEastLon;
	
				var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2)
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
				var distance = 3958.8 * c;
				var radius = distance/2;
				console.log(radius);
				var radiusMeters = radius * 1609.34;
				console.log(radiusMeters);
				vm.radius2 = radiusMeters;
			}
	
			
			function GetJSON(url){
			var p = new Promise((resolve, reject) => {
				var req = new XMLHttpRequest();
				req.onreadystatechange = function(){
					if(req.readyState == 4 && req.status == 200){
						var data = JSON.parse(req.response);
						resolve(data);
					}
					else if(req.readyState == 4){
						reject("Error:" + req.status);
					}
				};
				req.open("GET", url, true);
				req.send();
			});
			return p;
			}
</script>
</html>
